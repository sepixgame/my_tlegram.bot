import json
import os
from datetime import datetime
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters, CallbackQueryHandler

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
CHANNEL_ID_1 = "@sepix_shop"
CHANNEL_ID_2 = "@sepix_trust"
GROUP_ID = "@sepix_gap"
ADMIN_ID = 826685726
BOT_USERNAME = "sepix_codm_bot"
DB_FILE = "users.json"

# --- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ---
def load_users():
    if os.path.exists(DB_FILE):
        try:
            with open(DB_FILE, "r") as f:
                data = json.load(f)
                if isinstance(data, list):
                    print("âš ï¸ users.json Ø¨Ù‡ ØµÙˆØ±Øª Ù„ÛŒØ³Øª Ø§Ø³Øª. ÙØ§ÛŒÙ„ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª. Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
                    return {}
                for uid in data:
                    data[uid]["invites"] = set(data[uid].get("invites", []))
                    data[uid]["daily"] = data[uid].get("daily", {})
                return data
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ users.json: {e}. Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
            return {}
    return {}

# --- Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ---
def save_users():
    with open(DB_FILE, "w") as f:
        json.dump({
            uid: {
                "points": user["points"],
                "invites": list(user["invites"]),
                "daily": user.get("daily", {})
            } for uid, user in users.items()
        }, f, indent=2)

users = load_users()

# --- Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª ---
async def is_user_member(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    try:
        member1 = await context.bot.get_chat_member(CHANNEL_ID_1, user_id)
        member2 = await context.bot.get_chat_member(CHANNEL_ID_2, user_id)
        member3 = await context.bot.get_chat_member(GROUP_ID, user_id)
        return all(m.status in ['member', 'administrator', 'creator'] for m in [member1, member2, member3])
    except:
        return False

async def check_membership(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if await is_user_member(update, context):
        await query.edit_message_text("âœ… Ø¹Ø¶ÙˆÛŒØª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ /start Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.")
    else:
        await query.edit_message_text("âŒ Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ù†ÛŒØ³ØªÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.")

# --- Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ ---
async def show_main_menu(update: Update):
    user_id = update.effective_user.id
    keyboard = [
        [KeyboardButton("ğŸ“¦ Ø³ÛŒ Ù¾ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†"), KeyboardButton("ğŸ« Ø¨ØªÙ„ Ù¾Ø³ Ø±Ø§ÛŒÚ¯Ø§Ù†")],
        [KeyboardButton("ğŸ”„ Ú†Ù†Ø¬ Ø§Ú©Ø§Ù†Øª Ú©Ø±Ú©ÛŒ"), KeyboardButton("ğŸ›¡ï¸ Ø³Ø§Ù„Ù… Ú©Ø±Ø¯Ù† Ø§Ú©Ø§Ù†Øª Ú©Ø±Ú©ÛŒ")],
        [KeyboardButton("ğŸ“¢ Ø¢Ú¯Ù‡ÛŒ ÙØ±ÙˆØ´ Ø§Ú©Ø§Ù†Øª"), KeyboardButton("ğŸ›’ Ø¢Ú¯Ù‡ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ú©Ø§Ù†Øª")],
        [KeyboardButton("ğŸ†˜ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"), KeyboardButton("ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª")]
    ]
    if user_id == ADMIN_ID:
        keyboard.append([KeyboardButton("ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")])
    await update.message.reply_text(
        "Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\nÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )

# --- Ø¯Ø³ØªÙˆØ± Ø´Ø±ÙˆØ¹ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if not await is_user_member(update, context):
        await update.message.reply_text(
            "Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ú¯Ø±ÙˆÙ‡ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ğŸ“£ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø§ÙˆÙ„", url=f"https://t.me/{CHANNEL_ID_1[1:]}")],
                [InlineKeyboardButton("ğŸ“£ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¯ÙˆÙ…", url=f"https://t.me/{CHANNEL_ID_2[1:]}")],
                [InlineKeyboardButton("ğŸ’¬ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú¯Ø±ÙˆÙ‡", url=f"https://t.me/{GROUP_ID[1:]}")],
                [InlineKeyboardButton("âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª", callback_data="check_membership")]
            ])
        )
        return

    if user_id not in users:
        users[user_id] = {"points": 0, "invites": set(), "daily": {}}
        save_users()

    await show_main_menu(update)

# --- Ù‡Ù†Ø¯Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ---
async def handle_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    text = update.message.text

    services = {
        "ğŸ“¦ Ø³ÛŒ Ù¾ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†": 3,
        "ğŸ« Ø¨ØªÙ„ Ù¾Ø³ Ø±Ø§ÛŒÚ¯Ø§Ù†": 2,
        "ğŸ”„ Ú†Ù†Ø¬ Ø§Ú©Ø§Ù†Øª Ú©Ø±Ú©ÛŒ": 2,
        "ğŸ›¡ï¸ Ø³Ø§Ù„Ù… Ú©Ø±Ø¯Ù† Ø§Ú©Ø§Ù†Øª Ú©Ø±Ú©ÛŒ": 2,
        "ğŸ“¢ Ø¢Ú¯Ù‡ÛŒ ÙØ±ÙˆØ´ Ø§Ú©Ø§Ù†Øª": 0,
        "ğŸ›’ Ø¢Ú¯Ù‡ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ú©Ø§Ù†Øª": 0,
        "ğŸ†˜ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ": 0
    }

    if text in services:
        cost = services[text]
        if cost > 0 and users[user_id]["points"] < cost:
            await update.message.reply_text(f"âŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø®Ø¯Ù…Øª Ø¨Ù‡ {cost} Ø§Ù…ØªÛŒØ§Ø² Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.")
            return
        if cost > 0:
            users[user_id]["points"] -= cost
            save_users()

        if text == "ğŸ“¢ Ø¢Ú¯Ù‡ÛŒ ÙØ±ÙˆØ´ Ø§Ú©Ø§Ù†Øª":
            context.user_data['state'] = text
            await update.message.reply_text(
                "#ÙØ±ÙˆØ´_Ø§Ú©Ø§Ù†Øª\n\n"
                "ğŸŒ | Ø±ÛŒØ¬Ù†: \n"
                "âš™ï¸ | Ù„ÛŒÙ†Ú©: \n"
                "ğŸ’ | Ø³ÛŒâ€ŒÙ¾ÛŒ: \n"
                "ğŸ”“ | Ø¨ØªÙ„ Ù¾Ø³: \n\n"
                "ğŸ“ | ØªÙˆØ¶ÛŒØ­Ø§Øª: \n\n"
                "ğŸ’µ | Ù‚ÛŒÙ…Øª :\n"
                "ğŸ”„ | Ø·Ø§Ù‚: Ù†Ø¯Ø§Ø±Ø¯\n\n"
                "ğŸ’³ | Ø¢ÛŒØ¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡: \n\n"
                "âœ… | Ø¢ÛŒØ¯ÛŒ ÙˆØ§Ø³Ø·Ù‡ : @mr_sepix ğŸ†”\n\n"
                "ğŸ› | @sepix_shop\n"
                "ğŸ›’ | @sepix_trust\n"
                "ğŸ’¬ | @sepix_gap"
            )

        elif text == "ğŸ›’ Ø¢Ú¯Ù‡ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ú©Ø§Ù†Øª":
            context.user_data['state'] = text
            await update.message.reply_text(
                "#Ø®Ø±ÛŒØ¯_Ø§Ú©Ø§Ù†Øª\n\n"
                "ğŸ“ | ØªÙˆØ¶ÛŒØ­Ø§Øª: \n\n"
                "ğŸ’µ | Ù‚ÛŒÙ…Øª :\n"
                "ğŸ”„ | Ø·Ø§Ù‚ :\n\n"
                "ğŸ’³ | Ø¢ÛŒØ¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø± : \n\n"
                "âœ… | Ø¢ÛŒØ¯ÛŒ ÙˆØ§Ø³Ø·Ù‡ : @mr_sepix ğŸ†”\n\n"
                "ğŸ› | @sepix_shop\n"
                "ğŸ›’ | @sepix_trust\n"
                "ğŸ’¬ | @sepix_gap"
            )

        else:
            messages = {
                "ğŸ“¦ Ø³ÛŒ Ù¾ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†": "Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ùˆ Ø§ÛŒÙ…ÛŒÙ„ Ø§Ú©Ø§Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.",
                "ğŸ« Ø¨ØªÙ„ Ù¾Ø³ Ø±Ø§ÛŒÚ¯Ø§Ù†": "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¨ØªÙ„ Ù¾Ø³ Ùˆ Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. (Ø­Ø¯Ø§Ú©Ø«Ø± Û³ Ø¹Ø¯Ø¯)",
                "ğŸ”„ Ú†Ù†Ø¬ Ø§Ú©Ø§Ù†Øª Ú©Ø±Ú©ÛŒ": "Ø±Ù…Ø² Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ Ùˆ ØªØ§ Û³ Ø±ÙˆØ² Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§Ø´ÛŒØ¯.",
                "ğŸ›¡ï¸ Ø³Ø§Ù„Ù… Ú©Ø±Ø¯Ù† Ø§Ú©Ø§Ù†Øª Ú©Ø±Ú©ÛŒ": "Ø±Ù…Ø² Ùˆ Ø¬ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯. ØªØ§ Û³ Ø±ÙˆØ² Ù¾ÛŒØ§Ù… Ø¯Ù‡ÛŒØ¯.",
                "ğŸ†˜ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ": "Ø³Ø¤Ø§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯. Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."
            }
            if text == "ğŸ†˜ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ":
                context.user_data['support'] = True

            await update.message.reply_text(messages.get(text, "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯."))
        return

    elif text == "ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª":
        invite_link = f"https://t.me/{BOT_USERNAME}?start={user_id}"
        await update.message.reply_text(
            f"ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø§Ø®ØªØµØ§ØµÛŒ Ø´Ù…Ø§:\n{invite_link}\nÙ‡Ø± Ú©Ø§Ø±Ø¨Ø± Ú©Ù‡ Ø¨Ø§ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯ØŒ Û± Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø´Ù…Ø§ ØªØ¹Ù„Ù‚ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯. (ØªØ§ Ø³Ù‚Ù Û±Û° Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø± Ø±ÙˆØ²)"
        )

    elif text == "ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†":
        if update.effective_user.id != ADMIN_ID:
            await update.message.reply_text("âŒ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ ÙÙ‚Ø· Ù…Ø®ØµÙˆØµ Ù…Ø¯ÛŒØ± Ø±Ø¨Ø§Øª Ø§Ø³Øª.")
            return
        filename = "users_list.txt"
        with open(filename, "w", encoding="utf-8") as f:
            f.write("ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n\n")
            for uid in users:
                try:
                    user = await context.bot.get_chat(int(uid))
                    username = f"@{user.username}" if user.username else f"ID: {uid}"
                    f.write(f"- {username} | Ø§Ù…ØªÛŒØ§Ø²: {users[uid]['points']}\n")
                except:
                    f.write(f"- ID: {uid} | Ø§Ù…ØªÛŒØ§Ø²: {users[uid]['points']} (Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ)\n")
        await update.message.reply_document(document=open(filename, "rb"), filename=filename, caption="ğŸ“„ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:")
        os.remove(filename)

    elif context.user_data.get('state'):
        await update.message.reply_text("âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.")
        context.user_data.pop('state')

    elif context.user_data.get("support"):
        await context.bot.send_message(chat_id=ADMIN_ID, text=f"Ù¾ÛŒØ§Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² {user_id}:\n{text}")
        await update.message.reply_text("Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        context.user_data["support"] = False

# --- Ø´Ø±ÙˆØ¹ Ø¨Ø§ Ø±ÙØ±Ø§Ù„ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡ ---
async def start_with_referral(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    args = context.args
    referrer = args[0] if args else None

    if user_id not in users:
        users[user_id] = {"points": 0, "invites": set(), "daily": {}}

    if referrer and referrer != user_id:
        ref_data = users.get(referrer)
        if ref_data and user_id not in ref_data["invites"]:
            today = datetime.now().strftime("%Y-%m-%d")
            daily_points = int(ref_data.get("daily", {}).get(today, 0))
            if daily_points < 10:
                ref_data["invites"].add(user_id)
                ref_data["points"] += 1
                ref_data.setdefault("daily", {})[today] = daily_points + 1
                save_users()

    save_users()
    await start(update, context)

# --- Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ---
app = ApplicationBuilder().token('7867275226:AAF7z0xC5OExUw02WeILCPDE_e5xvFmxUTQ').build()
app.add_handler(CommandHandler("start", start_with_referral))
app.add_handler(CommandHandler("invite", lambda u, c: u.message.reply_text("Ø§Ø² Ù…Ù†ÙˆÛŒ Ø±Ø¨Ø§Øª Ú¯Ø²ÛŒÙ†Ù‡ Â«ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØªÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.")))
app.add_handler(CallbackQueryHandler(check_membership, pattern="check_membership"))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_messages))

print("âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯.")
app.run_polling()
